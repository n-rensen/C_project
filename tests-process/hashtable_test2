#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <stdint.h>
#include <stdbool.h>

#define MAX_PASSW 256
#define TABLE_SIZE 10
#define DELETED_NODE (password*)(0xFFFFFFFFFFFFFFFFUL)

typedef struct {
    char passw[MAX_PASSW];
    int hashpass;
} password;

password * hash_table[TABLE_SIZE];

// hash function
unsigned int hash(char *passw){
    int length = strnlen(passw, MAX_PASSW);
    unsigned int hash_value = 0;

    for (int i = 0; i < length; i++){
        hash_value += passw[i];
        hash_value = (hash_value * passw[i]) % TABLE_SIZE; // La contenance maximale etant fixee a 10.
    }

    return hash_value;
}

// initialise table
void init_hash_table() {
    for (int i=0; i < TABLE_SIZE; i++){
        hash_table[i] = NULL;
    }
}


// printing table
void print_table(){
    printf("TABLE START \n");
    for(int i=0; i < TABLE_SIZE; i++){
        if (hash_table[i] == NULL){
            printf("\t%i\t---\n", i);
        } else if (hash_table[i] == DELETED_NODE){
            printf("\t%i\t---<deleted>\n", i);
        } else {   
            printf("\t%i\t%s\n", i, hash_table[i]->passw);
        }
    }
    printf("TABLE END \n");
}

// insert function
bool hash_table_insert(password *p){
    if (p == NULL) return false;
    int index = hash(p->passw);
    for (int i=0; i < TABLE_SIZE; i++){
        int try = (i + index) % TABLE_SIZE;
        if (hash_table[try] == NULL || hash_table[try] == DELETED_NODE) {
            hash_table[try] = p;
            return true;
        }
    }
    return false;

    /*if(hash_table[index] != NULL){
        return false;
    }*/

    hash_table[index] = p;
    return true;
}

// lookup function
password *hashtable_lookup (char *passw){
    int index = hash(passw);
    for (int i=0; i < TABLE_SIZE; i++){
        int try = (index + i) % TABLE_SIZE;
        if (hash_table[try] == NULL){
            return false;
        }
        if(hash_table[try] == DELETED_NODE){
            continue;
        }

        if (hash_table[try] != NULL && strncmp(hash_table[try]->passw, passw, TABLE_SIZE) == 0){
            return hash_table[try];
        }
    }
    return NULL;
}

password*hash_table_delete(char *passw){
    int index = hash(passw);
    for (int i=0; i < TABLE_SIZE; i++){
        int try = (index + i) % TABLE_SIZE;
        if (hash_table[try] == NULL){
            return NULL;
        }
        if (hash_table[try] == DELETED_NODE){
            continue;
        }
        if (hash_table[try] != NULL && strncmp(hash_table[try]->passw, passw, TABLE_SIZE) == 0){

            password* tmp = hash_table[try];
            hash_table[try] = DELETED_NODE;
            return tmp;
        }
    }
    return NULL;
}

// main function
int main() {
    init_hash_table();
    print_table();
    //return 0;

    password Azertyuiop = {.passw="Azertyuiop", .hashpass=5};
    password Azerty = {.passw="Azerty", .hashpass=6};
    password admin = {.passw="admin", .hashpass=12};

    hash_table_insert(&Azertyuiop);
    hash_table_insert(&Azerty);
    hash_table_insert(&admin);

    print_table();

    password *tmp = hashtable_lookup("admin");

    if (tmp == NULL){
        printf("Not found !\n");
    } else {
        printf("Found %s.\n");
    }

    tmp = hashtable_lookup("BruceToutPuissant");

    if (tmp == NULL){
        printf("Not found !\n");
    } else {
        printf("Found %s.\n");
    }
}